<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L3 Messages</title>
    <script src="js/spx_interface.js"></script>
    <link rel="stylesheet" type="text/css" href="css/spx_fonts.css" />
    <link rel="stylesheet" type="text/css" id="DynamicTheme" href="themes/default.css" />
    <link rel="stylesheet" href="./L3_MESSAGES/L3_MESSAGES.css">
    <script>
        let isLooping = true;
        function runTemplateUpdate() {
            // is Looping Checkbox
            isLoopingCheckbox = htmlDecode(e('f68').innerHTML);
            isLooping = isLoopingCheckbox == 1 ? true : false;
        }

        function runAnimationIN() {
        }

        function runAnimationOUT() {
            const container = document.querySelector('.container');
            container.style.animation = 'fadeOut 0.5s forwards';
            setTimeout(() => {
                container.innerHTML = '';
            }, 500);
        }

        window.onload = function () {
            preparePages();
        }

        function preparePages() {
            setTimeout(() => {
                const pagesContainer = document.getElementById('pages');
                pagesContainer.innerHTML = '';

                const transitionDuration = htmlDecode(e('f81').innerHTML);
                const transitionDurationNumber = +transitionDuration * 1000;

                // Decoder element to convert HTML entities to characters
                const decoder = document.createElement('textarea');
                const decodeHtml = (value) => {
                    if (!value) return '';
                    let prev = value;
                    let decoded = value;
                    let safety = 0;
                    do {
                        prev = decoded;
                        decoder.innerHTML = prev;
                        decoded = decoder.value;
                        safety++;
                    } while (decoded !== prev && safety < 5);
                    return decoded;
                };

                const getFieldText = (fieldId) => {
                    const el = document.getElementById(fieldId);
                    if (!el) return '';
                    const raw = el.innerHTML;
                    return decodeHtml(raw).trim();
                };

                // Helper to set container vertical position based on line count
                const container = document.querySelector('.container');
                const setContainerLinesClass = (linesCount) => {
                    container.classList.remove('two-lines', 'three-lines');
                    if (linesCount === 2) {
                        container.classList.add('two-lines');
                    } else {
                        container.classList.add('three-lines');
                    }
                };

                // Truncate text to fit within two lines and container width
                const truncateToFit = (el, containerEl) => {
                    const style = getComputedStyle(el);
                    const lineHeight = parseFloat(style.lineHeight) || 30;
                    const maxHeight = lineHeight * 2 + 2; // small tolerance
                    const maxWidth = containerEl.clientWidth - 30; // account for right padding

                    const original = el.textContent || '';
                    let low = 0, high = original.length, best = original.length;

                    const fits = () => {
                        // Allow wrapping; check both width and height constraints
                        const tooTall = el.scrollHeight > maxHeight;
                        const tooWide = el.scrollWidth > maxWidth;
                        return !(tooTall || tooWide);
                    };

                    // If already fits, do nothing
                    if (original.length === 0) return;
                    if (fits()) return;

                    // Binary search the cut point
                    while (low <= high) {
                        const mid = Math.floor((low + high) / 2);
                        const candidate = original.slice(0, mid).trim() + '…';
                        el.textContent = candidate;
                        if (fits()) {
                            best = mid;
                            low = mid + 1;
                        } else {
                            high = mid - 1;
                        }
                    }

                    const finalText = original.slice(0, best).trim() + '…';
                    el.textContent = finalText;
                };

                const createPage = (index) => {
                    const nameText = getFieldText(`f${index * 6 - 4}`);
                    const titleText = getFieldText(`f${index * 6 - 3}`);

                    if (!nameText || !titleText) {
                        return null;
                    }

                    // Use full titleText without splitting. Truncation applied later if needed.
                    const fullMessage = titleText;

                    // Page
                    const page = document.createElement('div');
                    page.className = 'page';
                    page.id = `page${index}`;

                    // Name / Title
                    const headerElement = document.createElement('h1');
                    const nameSpan = document.createElement('span');
                    const messageSpan = document.createElement('span');

                    nameSpan.id = `f${index * 6 - 4}_gfx`;
                    nameSpan.className = 'name';
                    nameSpan.innerHTML = nameText;

                    messageSpan.id = `f${index * 6 - 3}_gfx`;
                    // Default font-size 30px, bump to 35px if total < 50 chars
                    const totalMessageLength = fullMessage.length;
                    const messageClass = totalMessageLength < 50 ? 'message large' : 'message';
                    messageSpan.className = messageClass;
                    messageSpan.textContent = fullMessage;

                    headerElement.appendChild(nameSpan);
                    headerElement.appendChild(messageSpan);

                    page.appendChild(headerElement);

                    return page;
                };

                const pages = [];

                for (let i = 1; i <= 10; i++) {
                    const page = createPage(i);
                    if (page) {
                        pages.push(page);
                    }
                }

                const displayPages = () => {
                    let currentPageIndex = 0;

                    const showPage = (page) => {
                        const messageSpan = page.querySelector('.message');
                        // After insertion, apply truncation if overflowing (limit to two lines)
                        // Temporarily append to measure

                        // Show page
                        pagesContainer.appendChild(page);
                        page.style.display = 'flex';
                        page.classList.add('fade-in');

                        // Apply truncation after in-flow render
                        truncateToFit(messageSpan, container);

                        // Set container vertical position (2 or 3 total lines inc. name)
                        const lineHeight = parseFloat(getComputedStyle(messageSpan).lineHeight) || 30;
                        const linesUsed = Math.round(messageSpan.scrollHeight / lineHeight);
                        const linesCount = 1 /* name */ + Math.min(linesUsed, 2);
                        setContainerLinesClass(linesCount);

                        // Hold for duration, then fade out page
                        setTimeout(() => {
                            page.classList.remove('fade-in');
                            page.classList.add('fade-out');

                            setTimeout(() => {
                                page.style.display = 'none';
                                page.classList.remove('fade-out');

                                // Move to the next page or handle end of loop
                                currentPageIndex++;
                                if (currentPageIndex < pages.length) {
                                    showPage(pages[currentPageIndex]);
                                } else if (isLooping) {
                                    currentPageIndex = 0;
                                    showPage(pages[currentPageIndex]);
                                } else {
                                    runAnimationOUT();
                                }
                            }, 250); // Fade-out duration
                        }, transitionDurationNumber);
                    };

                    if (pages.length > 0) {
                        showPage(pages[0]); // Start the animation
                    }
                };

                // Start the animation sequence
                displayPages();
            }, 10);
        }
    </script>
    <script type="text/javascript">
        window.SPXGCTemplateDefinition = {
            "defversion": "1",
            "description": "Lower Third Messages",
            "playserver": "OVERLAY",
            "playchannel": "1",
            "playlayer": "9",
            "webplayout": "9",
            "out": "manual",
            "dataformat": "json",
            "uicolor": "1",
            "DataFields": [
                {
                    "field": "f81",
                    "ftype": "textfield",
                    "title": "Transition (s)",
                    "value": "10"
                },
                {
                    "ftype": "caption",
                    "value": "Item 1"
                },
                {
                    "field": "f2",
                    "ftype": "textfield",
                    "title": "Name",
                    "value": "Name"
                },
                {
                    "field": "f3",
                    "ftype": "textfield",
                    "title": "Message",
                    "value": "Message"
                },
                {
                    "ftype": "divider"
                },
                {
                    "ftype": "caption",
                    "value": "Item 2"
                },
                {
                    "field": "f8",
                    "ftype": "textfield",
                    "title": "Name",
                    "value": ""
                },
                {
                    "field": "f9",
                    "ftype": "textfield",
                    "title": "Message",
                    "value": ""
                },
                {
                    "ftype": "divider"
                },
                {
                    "ftype": "caption",
                    "value": "Item 3"
                },
                {
                    "field": "f14",
                    "ftype": "textfield",
                    "title": "Name",
                    "value": ""
                },
                {
                    "field": "f15",
                    "ftype": "textfield",
                    "title": "Message",
                    "value": ""
                },
                {
                    "ftype": "divider"
                },
                {
                    "ftype": "caption",
                    "value": "Item 4"
                },
                {
                    "field": "f20",
                    "ftype": "textfield",
                    "title": "Name",
                    "value": ""
                },
                {
                    "field": "f21",
                    "ftype": "textfield",
                    "title": "Message",
                    "value": ""
                },
                {
                    "ftype": "divider"
                },
                {
                    "ftype": "caption",
                    "value": "Item 5"
                },
                {
                    "field": "f26",
                    "ftype": "textfield",
                    "title": "Name",
                    "value": ""
                },
                {
                    "field": "f27",
                    "ftype": "textfield",
                    "title": "Message",
                    "value": ""
                },
                {
                    "ftype": "divider"
                },
                {
                    "ftype": "caption",
                    "value": "Item 6"
                },
                {
                    "field": "f32",
                    "ftype": "textfield",
                    "title": "Name",
                    "value": ""
                },
                {
                    "field": "f32",
                    "ftype": "textfield",
                    "title": "Message",
                    "value": ""
                },
                {
                    "ftype": "divider"
                },
                {
                    "ftype": "caption",
                    "value": "Item 7"
                },
                {
                    "field": "f38",
                    "ftype": "textfield",
                    "title": "Name",
                    "value": ""
                },
                {
                    "field": "f39",
                    "ftype": "textfield",
                    "title": "Message",
                    "value": ""
                },
                {
                    "ftype": "divider"
                },
                {
                    "ftype": "caption",
                    "value": "Item 8"
                },
                {
                    "field": "f44",
                    "ftype": "textfield",
                    "title": "Name",
                    "value": ""
                },
                {
                    "field": "f45",
                    "ftype": "textfield",
                    "title": "Message",
                    "value": ""
                },
                {
                    "ftype": "divider"
                },
                {
                    "ftype": "caption",
                    "value": "Item 9"
                },
                {
                    "field": "f50",
                    "ftype": "textfield",
                    "title": "Name",
                    "value": ""
                },
                {
                    "field": "f51",
                    "ftype": "textfield",
                    "title": "Message",
                    "value": ""
                },
                {
                    "ftype": "divider"
                },
                {
                    "ftype": "caption",
                    "value": "Item 10"
                },
                {
                    "field": "f56",
                    "ftype": "textfield",
                    "title": "Name",
                    "value": ""
                },
                {
                    "field": "f57",
                    "ftype": "textfield",
                    "title": "Message",
                    "value": ""
                },
                {
                    "ftype": "divider"
                },
                {
                    "field": "f67",
                    "ftype": "hidden",
                    "title": "Total Out",
                    "value": "manual"
                },
                {
                    "field": "f68",
                    "ftype": "checkbox",
                    "title": "Loop Graphic",
                    "value": "1",
                }
            ]
        };
    </script>
</head>

<body>
    <div class="container">
        <div id="pages">
            <div class="page">
                <h1>
                    <span class="name"></span>
                    <span class="message"></span>
                    <span class="message part-2"></span>
                </h1>
            </div>
        </div>

        <div style="display:none;" id="f1"></div>
        <div style="display:none;" id="f2"></div>
        <div style="display:none;" id="f3"></div>
        <div style="display:none;" id="f4"></div>
        <div style="display:none;" id="f5"></div>
        <div style="display:none;" id="f6"></div>
        <div style="display:none;" id="f7"></div>
        <div style="display:none;" id="f8"></div>
        <div style="display:none;" id="f9"></div>
        <div style="display:none;" id="f10"></div>
        <div style="display:none;" id="f11"></div>
        <div style="display:none;" id="f12"></div>
        <div style="display:none;" id="f13"></div>
        <div style="display:none;" id="f14"></div>
        <div style="display:none;" id="f15"></div>
        <div style="display:none;" id="f16"></div>
        <div style="display:none;" id="f17"></div>
        <div style="display:none;" id="f18"></div>
        <div style="display:none;" id="f19"></div>
        <div style="display:none;" id="f20"></div>
        <div style="display:none;" id="f21"></div>
        <div style="display:none;" id="f22"></div>
        <div style="display:none;" id="f23"></div>
        <div style="display:none;" id="f24"></div>
        <div style="display:none;" id="f25"></div>
        <div style="display:none;" id="f26"></div>
        <div style="display:none;" id="f27"></div>
        <div style="display:none;" id="f28"></div>
        <div style="display:none;" id="f29"></div>
        <div style="display:none;" id="f30"></div>
        <div style="display:none;" id="f31"></div>
        <div style="display:none;" id="f32"></div>
        <div style="display:none;" id="f33"></div>
        <div style="display:none;" id="f34"></div>
        <div style="display:none;" id="f35"></div>
        <div style="display:none;" id="f36"></div>
        <div style="display:none;" id="f37"></div>
        <div style="display:none;" id="f38"></div>
        <div style="display:none;" id="f39"></div>
        <div style="display:none;" id="f40"></div>
        <div style="display:none;" id="f41"></div>
        <div style="display:none;" id="f42"></div>
        <div style="display:none;" id="f43"></div>
        <div style="display:none;" id="f44"></div>
        <div style="display:none;" id="f45"></div>
        <div style="display:none;" id="f46"></div>
        <div style="display:none;" id="f47"></div>
        <div style="display:none;" id="f48"></div>
        <div style="display:none;" id="f49"></div>
        <div style="display:none;" id="f50"></div>
        <div style="display:none;" id="f51"></div>
        <div style="display:none;" id="f52"></div>
        <div style="display:none;" id="f53"></div>
        <div style="display:none;" id="f54"></div>
        <div style="display:none;" id="f55"></div>
        <div style="display:none;" id="f56"></div>
        <div style="display:none;" id="f57"></div>
        <div style="display:none;" id="f58"></div>
        <div style="display:none;" id="f59"></div>
        <div style="display:none;" id="f60"></div>
        <div style="display:none;" id="f66"></div>
        <div style="opacity:0;" id="f67"></div>
        <div style="opacity:0;" id="f68"></div>
        <div style="opacity:0;" id="f81"></div>
    </div>
</body>

</html>